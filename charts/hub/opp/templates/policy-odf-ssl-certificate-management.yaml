apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CA Assessment Authorization and
      Monitoring
    policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
    argocd.argoproj.io/compare-options: IgnoreExtraneous
    argocd.argoproj.io/sync-options: Prune=false
    argocd.argoproj.io/health-check-ignore: "true"
    argocd.argoproj.io/hook: "PostSync"
    argocd.argoproj.io/sync-wave: "2"
  labels:
    app.kubernetes.io/name: odf-ssl-certificate-management
    app.kubernetes.io/component: policy
  name: policy-odf-ssl-certificate-management
  namespace: open-cluster-management
spec:
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: policy-odf-ssl-certificate-management
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        object-templates:
        - complianceType: musthave
          recreateOption: recreate
          objectDefinition:
            apiVersion: batch/v1
            kind: Job
            metadata:
              name: odf-ssl-certificate-extractor
              namespace: openshift-config
              labels:
                app.kubernetes.io/name: odf-ssl-certificate-management
                app.kubernetes.io/component: certificate-extraction
              annotations:
                argocd.argoproj.io/hook: "PostSync"
                argocd.argoproj.io/hook-delete-policy: "HookSucceeded"
                argocd.argoproj.io/sync-wave: "2"
            spec:
              template:
                spec:
                  containers:
                  - name: odf-ssl-extractor
                    image: registry.redhat.io/openshift4/ose-cli:latest
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "200m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                    command:
                    - /bin/bash
                    - -c
                    - |
                      set -euo pipefail
                      
                      echo "Starting ODF SSL certificate extraction and distribution..."
                      echo "Following Red Hat ODF Disaster Recovery certificate management guidelines"
                      
                      # Create working directory
                      WORK_DIR="/tmp/odf-ssl-certs"
                      mkdir -p "$WORK_DIR"
                      
                      # Function to extract CA from cluster
                      extract_cluster_ca() {
                        local cluster_name="$1"
                        local output_file="$2"
                        local kubeconfig="${3:-}"
                        
                        echo "Extracting CA from cluster: $cluster_name"
                        
                        if [[ -n "$kubeconfig" && -f "$kubeconfig" ]]; then
                          # Use provided kubeconfig
                          if oc --kubeconfig="$kubeconfig" get configmap -n openshift-config-managed trusted-ca-bundle -o jsonpath="{.data['ca-bundle\.crt']}" > "$output_file" 2>/dev/null; then
                            echo "  CA extracted from $cluster_name using kubeconfig"
                            return 0
                          fi
                        else
                          # Use current context (hub cluster)
                          if oc get configmap -n openshift-config-managed trusted-ca-bundle -o jsonpath="{.data['ca-bundle\.crt']}" > "$output_file" 2>/dev/null; then
                            echo "  CA extracted from $cluster_name using current context"
                            return 0
                          fi
                        fi
                        
                        echo "  Failed to extract CA from $cluster_name"
                        return 1
                      }
                      
                      # Function to create combined CA bundle
                      create_combined_ca_bundle() {
                        local output_file="$1"
                        shift
                        local ca_files=("$@")
                        
                        echo "Creating combined CA bundle..."
                        > "$output_file"
                        
                        local file_count=0
                        for ca_file in "${ca_files[@]}"; do
                          if [[ -f "$ca_file" && -s "$ca_file" ]]; then
                            echo "# CA from $(basename "$ca_file" .crt)" >> "$output_file"
                            cat "$ca_file" >> "$output_file"
                            echo "" >> "$output_file"
                            file_count=$((file_count + 1))
                          fi
                        done
                        
                        if [[ $file_count -gt 0 ]]; then
                          echo "Combined CA bundle created with $file_count CA certificates"
                          return 0
                        else
                          echo "No valid CA files found to combine"
                          return 1
                        fi
                      }
                      
                      # Extract hub cluster CA
                      echo "1. Extracting hub cluster CA..."
                      if extract_cluster_ca "hub" "$WORK_DIR/hub-ca.crt"; then
                        echo "  Hub cluster CA extracted successfully"
                      else
                        echo "  Failed to extract hub cluster CA"
                        exit 1
                      fi
                      
                      # Get managed clusters
                      echo "2. Discovering managed clusters..."
                      MANAGED_CLUSTERS=$(oc get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
                      
                      if [[ -z "$MANAGED_CLUSTERS" ]]; then
                        echo "  No managed clusters found"
                      else
                        echo "  Found managed clusters: $MANAGED_CLUSTERS"
                      fi
                      
                      # Extract CA from each managed cluster
                      CA_FILES=("$WORK_DIR/hub-ca.crt")
                      local index=1
                      
                      for cluster in $MANAGED_CLUSTERS; do
                        if [[ "$cluster" == "local-cluster" ]]; then
                          continue
                        fi
                        
                        echo "3.$index Extracting CA from $cluster..."
                        
                        # Try to get kubeconfig for the cluster
                        KUBECONFIG_FILE=""
                        if oc get secret -n "$cluster" -o name | grep -E "(admin-kubeconfig|kubeconfig)" | head -1 | xargs -I {} oc get {} -n "$cluster" -o jsonpath='{.data.kubeconfig}' | base64 -d > "$WORK_DIR/${cluster}-kubeconfig.yaml" 2>/dev/null; then
                          KUBECONFIG_FILE="$WORK_DIR/${cluster}-kubeconfig.yaml"
                        fi
                        
                        if extract_cluster_ca "$cluster" "$WORK_DIR/${cluster}-ca.crt" "$KUBECONFIG_FILE"; then
                          CA_FILES+=("$WORK_DIR/${cluster}-ca.crt")
                        else
                          echo "  Warning: Could not extract CA from $cluster, continuing..."
                        fi
                        
                        ((index++))
                      done
                      
                      # Create combined CA bundle
                      echo "4. Creating combined CA bundle..."
                      if create_combined_ca_bundle "$WORK_DIR/combined-ca-bundle.crt" "${CA_FILES[@]}"; then
                        echo "  Combined CA bundle created successfully"
                      else
                        echo "  Failed to create combined CA bundle"
                        exit 1
                      fi
                      
                      # Create ConfigMap on hub cluster
                      echo "5. Creating cluster-proxy-ca-bundle ConfigMap on hub cluster..."
                      oc create configmap cluster-proxy-ca-bundle \
                        --from-file=ca-bundle.crt="$WORK_DIR/combined-ca-bundle.crt" \
                        -n openshift-config \
                        --dry-run=client -o yaml | oc apply -f -
                      
                      # Update hub cluster proxy
                      echo "6. Updating hub cluster proxy configuration..."
                      oc patch proxy/cluster --type=merge --patch='{"spec":{"trustedCA":{"name":"cluster-proxy-ca-bundle"}}}' || {
                        echo "  Warning: Could not update hub cluster proxy"
                      }
                      
                      # Create placement rule for managed clusters
                      echo "7. Creating placement rule for managed clusters..."
                      cat <<EOF | oc apply -f -
                      apiVersion: apps.open-cluster-management.io/v1
                      kind: PlacementRule
                      metadata:
                        name: placement-odf-ssl-certificate-distribution
                        namespace: open-cluster-management
                      spec:
                        clusterConditions:
                        - type: ManagedClusterConditionAvailable
                          status: "True"
                        clusterSelector:
                          matchExpressions:
                          - key: cluster.open-cluster-management.io/clusterset
                            operator: Exists
                          - key: purpose
                            operator: In
                            values: ["regionalDR"]
                      EOF
                      
                      # Create policy for managed cluster CA bundle distribution
                      echo "8. Creating policy for managed cluster CA bundle distribution..."
                      cat <<EOF | oc apply -f -
                      apiVersion: policy.open-cluster-management.io/v1
                      kind: Policy
                      metadata:
                        name: policy-odf-ssl-certificate-distribution
                        namespace: open-cluster-management
                        labels:
                          app.kubernetes.io/name: odf-ssl-certificate-management
                          app.kubernetes.io/component: distribution
                      spec:
                        disabled: false
                        policy-templates:
                        - objectDefinition:
                            apiVersion: policy.open-cluster-management.io/v1
                            kind: ConfigurationPolicy
                            metadata:
                              name: policy-odf-ssl-certificate-distribution
                            spec:
                              object-templates:
                              - complianceType: musthave
                                objectDefinition:
                                  apiVersion: v1
                                  kind: ConfigMap
                                  metadata:
                                    name: cluster-proxy-ca-bundle
                                    namespace: openshift-config
                                  data:
                                    ca-bundle.crt: |
                                      $(cat "$WORK_DIR/combined-ca-bundle.crt" | sed 's/^/                                      /')
                              - complianceType: musthave
                                objectDefinition:
                                  apiVersion: config.openshift.io/v1
                                  kind: Proxy
                                  metadata:
                                    name: cluster
                                  spec:
                                    trustedCA:
                                      name: cluster-proxy-ca-bundle
                              remediationAction: enforce
                              severity: high
                      EOF
                      
                      # Create placement binding
                      echo "9. Creating placement binding..."
                      cat <<EOF | oc apply -f -
                      apiVersion: policy.open-cluster-management.io/v1
                      kind: PlacementBinding
                      metadata:
                        name: binding-odf-ssl-certificate-distribution
                        namespace: open-cluster-management
                      placementRef:
                        name: placement-odf-ssl-certificate-distribution
                        kind: PlacementRule
                        apiGroup: apps.open-cluster-management.io
                      subjects:
                      - name: policy-odf-ssl-certificate-distribution
                        kind: Policy
                        apiGroup: policy.open-cluster-management.io
                      EOF
                      
                      # Verify the configuration
                      echo "10. Verifying configuration..."
                      echo "  Hub cluster ConfigMap:"
                      oc get configmap cluster-proxy-ca-bundle -n openshift-config -o jsonpath='{.metadata.name}' && echo " - Created"
                      
                      echo "  Hub cluster proxy:"
                      oc get proxy cluster -o jsonpath='{.spec.trustedCA.name}' && echo " - Configured"
                      
                      echo "  Placement rule:"
                      oc get placementrule placement-odf-ssl-certificate-distribution -n open-cluster-management -o jsonpath='{.metadata.name}' && echo " - Created"
                      
                      echo "  Distribution policy:"
                      oc get policy policy-odf-ssl-certificate-distribution -n open-cluster-management -o jsonpath='{.metadata.name}' && echo " - Created"
                      
                      echo ""
                      echo "âœ… ODF SSL certificate management completed successfully!"
                      echo "   - Hub cluster CA bundle: Updated"
                      echo "   - Hub cluster proxy: Configured"
                      echo "   - Managed cluster policies: Created"
                      echo "   - Placement rules: Configured"
                      echo ""
                      echo "This follows Red Hat ODF Disaster Recovery certificate management guidelines"
                      echo "for secure SSL access across clusters in the regional DR setup."
                      
                      # Cleanup
                      rm -rf "$WORK_DIR"
                    env:
                    - name: KUBECONFIG
                      value: ""
                  restartPolicy: Never
                  serviceAccountName: odf-ssl-extractor-sa
              backoffLimit: 1
              activeDeadlineSeconds: 900
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: ServiceAccount
            metadata:
              name: odf-ssl-extractor-sa
              namespace: openshift-config
              labels:
                app.kubernetes.io/name: odf-ssl-certificate-management
                app.kubernetes.io/component: certificate-extraction
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRole
            metadata:
              name: odf-ssl-extractor-role
              labels:
                app.kubernetes.io/name: odf-ssl-certificate-management
                app.kubernetes.io/component: certificate-extraction
            rules:
            - apiGroups: [""]
              resources: ["configmaps", "secrets"]
              verbs: ["get", "list", "create", "update", "patch"]
            - apiGroups: ["config.openshift.io"]
              resources: ["proxies"]
              verbs: ["get", "patch"]
            - apiGroups: ["cluster.open-cluster-management.io"]
              resources: ["managedclusters"]
              verbs: ["get", "list"]
            - apiGroups: ["internal.open-cluster-management.io"]
              resources: ["managedclusterinfos"]
              verbs: ["get", "list"]
            - apiGroups: ["policy.open-cluster-management.io"]
              resources: ["policies", "placementrules", "placementbindings"]
              verbs: ["get", "list", "create", "update", "patch"]
            - apiGroups: ["apps.open-cluster-management.io"]
              resources: ["placementrules"]
              verbs: ["get", "list", "create", "update", "patch"]
        - complianceType: musthave
          objectDefinition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: ClusterRoleBinding
            metadata:
              name: odf-ssl-extractor-rolebinding
              labels:
                app.kubernetes.io/name: odf-ssl-certificate-management
                app.kubernetes.io/component: certificate-extraction
            subjects:
            - kind: ServiceAccount
              name: odf-ssl-extractor-sa
              namespace: openshift-config
            roleRef:
              kind: ClusterRole
              name: odf-ssl-extractor-role
              apiGroup: rbac.authorization.k8s.io
        remediationAction: enforce
        severity: high
